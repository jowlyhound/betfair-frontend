<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK & Ireland Racing - Daily Schedule</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #0f1419;
            color: #e6edf3;
            line-height: 1.5;
        }

        .header {
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #30363d;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #238636;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .connection-status.connected {
            background: rgba(35, 134, 54, 0.15);
            color: #238636;
            border: 1px solid rgba(35, 134, 54, 0.3);
        }

        .connection-status.disconnected {
            background: rgba(218, 54, 51, 0.15);
            color: #da3633;
            border: 1px solid rgba(218, 54, 51, 0.3);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .date-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .date-title {
            font-size: 2rem;
            font-weight: 700;
            color: #e6edf3;
            margin-bottom: 0.5rem;
        }

        .date-subtitle {
            font-size: 1rem;
            color: #7d8590;
        }

        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: #7d8590;
        }

        .loading-spinner {
            width: 2rem;
            height: 2rem;
            border: 2px solid #21262d;
            border-top: 2px solid #238636;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-racing {
            text-align: center;
            padding: 4rem 2rem;
            color: #7d8590;
        }

        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .course-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .course-card:hover {
            border-color: #238636;
            transform: translateY(-2px);
        }

        .course-header {
            background: linear-gradient(135deg, #21262d 0%, #161b22 100%);
            padding: 1.5rem;
            border-bottom: 1px solid #30363d;
        }

        .course-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #238636;
            margin-bottom: 0.5rem;
        }

        .course-info {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #7d8590;
        }

        .race-list {
            padding: 1rem;
        }

        .race-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin: 0.5rem 0;
            background: #0d1117;
            border-radius: 8px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .race-item:hover {
            background: #161b22;
            border-left-color: #238636;
        }

        .race-item.selected {
            background: rgba(35, 134, 54, 0.1);
            border-left-color: #238636;
        }

        .race-time {
            font-size: 1.2rem;
            font-weight: 700;
            color: #e6edf3;
        }

        .race-name {
            font-size: 0.9rem;
            color: #7d8590;
            margin-top: 0.2rem;
        }

        .race-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
        }

        .runners-count {
            background: #21262d;
            color: #7d8590;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
        }

        .pattern-indicator {
            background: #f85149;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .race-details {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-top: 1rem;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .race-details.open {
            max-height: 600px;
            opacity: 1;
        }

        .details-header {
            background: #161b22;
            padding: 1rem;
            border-bottom: 1px solid #30363d;
            font-weight: 600;
            color: #e6edf3;
        }

        .horses-list {
            padding: 0;
        }

        .horse-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #21262d;
            transition: background 0.2s ease;
        }

        .horse-item:hover {
            background: #161b22;
        }

        .horse-item.strong-pattern {
            background: rgba(248, 81, 73, 0.1);
            border-left: 4px solid #f85149;
        }

        .horse-item.pattern-detected {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
        }

        .horse-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .horse-name {
            font-weight: 600;
            color: #e6edf3;
            font-size: 1rem;
        }

        .horse-patterns {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .pattern-badge {
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 12px;
            font-weight: 500;
        }

        .pattern-steam { background: #f85149; color: white; }
        .pattern-volume { background: #a855f7; color: white; }
        .pattern-pressure { background: #3b82f6; color: white; }
        .pattern-confidence { background: #10b981; color: white; }

        .horse-stats {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }

        .horse-odds {
            font-size: 1.1rem;
            font-weight: 700;
            color: #238636;
        }

        .confidence-score {
            font-size: 0.8rem;
            color: #7d8590;
        }

        .time-to-race {
            font-size: 0.8rem;
            color: #7d8590;
        }

        .time-to-race.soon {
            color: #f85149;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .main-container {
                padding: 1rem;
            }
            
            .courses-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                üèá UK & Ireland Racing
            </div>
            
            <div class="connection-status" id="connectionStatus">
                <div class="status-dot"></div>
                <span id="connectionText">Connecting...</span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="date-header">
            <h1 class="date-title" id="dateTitle">Today's Racing</h1>
            <p class="date-subtitle" id="dateSubtitle">Loading schedule...</p>
        </div>

        <div id="racingContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading today's racing schedule...</p>
            </div>
        </div>
    </div>

    <script>
        class DailyRacingSchedule {
            constructor() {
                this.ws = null;
                this.courses = new Map();
                this.selectedRace = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 2000;
                
                this.wsUrls = [
                    'ws://localhost:11002',
                    'ws://194.164.95.216:11002',
                    'wss://bidding-luxury-graduation-each.trycloudflare.com'
                ];
                
                this.updateDateHeader();
                this.connect();
                
                // Update times every minute
                setInterval(() => this.updateRaceTimes(), 60000);
            }

            updateDateHeader() {
                const today = new Date();
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                
                document.getElementById('dateTitle').textContent = 
                    today.toLocaleDateString('en-GB', options);
                document.getElementById('dateSubtitle').textContent = 
                    'UK & Ireland Racing Schedule';
            }

            connect() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) return;

                const wsUrl = this.wsUrls[this.reconnectAttempts % this.wsUrls.length];
                console.log(`Connecting to: ${wsUrl}`);
                
                try {
                    this.ws = new WebSocket(wsUrl);
                    this.setupWebSocket();
                } catch (error) {
                    console.error('WebSocket connection error:', error);
                    this.handleReconnect();
                }
            }

            setupWebSocket() {
                this.ws.onopen = () => {
                    console.log('Connected to racing backend');
                    this.updateConnectionStatus(true);
                    this.reconnectAttempts = 0;
                    
                    // Send hello message
                    this.ws.send(JSON.stringify({
                        type: 'hello',
                        client: 'daily-schedule',
                        timestamp: Date.now()
                    }));
                    
                    // Request market data
                    this.ws.send(JSON.stringify({
                        type: 'get_markets'
                    }));
                };

                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.processMessage(data);
                    } catch (error) {
                        console.error('Message processing error:', error);
                    }
                };

                this.ws.onclose = () => {
                    console.log('WebSocket connection closed');
                    this.updateConnectionStatus(false);
                    this.handleReconnect();
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.updateConnectionStatus(false);
                };
            }

            processMessage(data) {
                console.log('Processing message:', data.type);

                // Handle Betfair market change messages that don't have a type field
                if (!data.type && (data.op === 'mcm' || data.mc)) {
                    data.type = 'mcm';
                }

                switch (data.type) {
                    case 'market_data':
                        this.processMarketData(data.markets);
                        break;
                    case 'mcm':
                        this.processMarketChanges(data);
                        break;
                    case 'welcome':
                        console.log('Backend welcome');
                        break;
                    case 'bf_status':
                        console.log('Betfair status:', data.message);
                        this.updateConnectionStatus(true, data.message);
                        break;
                    case 'bf_status_error':
                        console.log('Betfair error:', data.error);
                        this.updateConnectionStatus(false, data.error);
                        break;
                    case 'status':
                        console.log('Backend status:', data.message);
                        break;
                    default:
                        console.log('Unknown message type:', data.type);
                }
            }

            processMarketData(markets) {
                if (!Array.isArray(markets)) return;

                console.log(`Processing ${markets.length} markets`);

                // Clear existing data
                this.courses.clear();

                markets.forEach(market => {
                    if (!this.isUKIrelandRacing(market)) return;
                    
                    const courseName = this.getCourseName(market);
                    const raceData = this.formatRaceData(market);
                    
                    if (!this.courses.has(courseName)) {
                        this.courses.set(courseName, {
                            name: courseName,
                            races: []
                        });
                    }
                    
                    this.courses.get(courseName).races.push(raceData);
                });

                // Sort races within each course by time
                for (const course of this.courses.values()) {
                    course.races.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
                }

                this.renderSchedule();
            }

            isUKIrelandRacing(market) {
                const venue = (market.venue || '').toLowerCase();
                const name = (market.name || '').toLowerCase();
                
                // Check for UK/Ireland indicators
                const ukIrelandIndicators = ['gb', 'ie', 'uk', 'ireland', 'british', 'irish'];
                const text = venue + ' ' + name;
                
                return ukIrelandIndicators.some(indicator => text.includes(indicator)) ||
                       this.isKnownUKIrelandCourse(venue);
            }

            isKnownUKIrelandCourse(venue) {
                const courses = [
                    'ascot', 'newmarket', 'cheltenham', 'aintree', 'epsom', 'goodwood',
                    'york', 'doncaster', 'chester', 'haydock', 'sandown', 'kempton',
                    'lingfield', 'wolverhampton', 'southwell', 'bath', 'beverley',
                    'carlisle', 'catterick', 'chepstow', 'exeter', 'fakenham',
                    'fontwell', 'hamilton', 'hereford', 'hexham', 'huntingdon',
                    'kelso', 'leicester', 'ludlow', 'market rasen', 'musselburgh',
                    'newbury', 'newton abbot', 'nottingham', 'perth', 'plumpton',
                    'pontefract', 'redcar', 'ripon', 'salisbury', 'sedgefield',
                    'stratford', 'taunton', 'thirsk', 'towcester', 'uttoxeter',
                    'warwick', 'wetherby', 'wincanton', 'windsor', 'worcester',
                    'yarmouth', 'curragh', 'leopardstown', 'bellewstown', 'cork',
                    'down royal', 'fairyhouse', 'galway', 'gowran park', 'killarney',
                    'limerick', 'listowel', 'naas', 'navan', 'punchestown',
                    'roscommon', 'sligo', 'thurles', 'tipperary', 'tramore', 'wexford'
                ];
                
                return courses.some(course => venue.includes(course));
            }

            getCourseName(market) {
                return market.venue || market.name || 'Unknown Course';
            }

            formatRaceData(market) {
                const startTime = new Date(market.startTime || Date.now());
                const runners = market.runners || [];
                
                // Analyze runners for patterns and favorites
                const analyzedRunners = runners.map(runner => {
                    const odds = parseFloat(runner.lastPrice) || 0;
                    const patterns = this.detectPatterns(runner);
                    
                    return {
                        id: runner.id,
                        name: runner.name || `Runner ${runner.id}`,
                        odds: odds,
                        patterns: patterns,
                        confidence: this.calculateConfidence(runner, patterns)
                    };
                }).sort((a, b) => (a.odds || 999) - (b.odds || 999));

                return {
                    marketId: market.id,
                    name: market.name || 'Race',
                    startTime: startTime,
                    runners: analyzedRunners,
                    hasPatterns: analyzedRunners.some(r => r.patterns.length > 0)
                };
            }

            detectPatterns(runner) {
                const patterns = [];
                
                // Mock pattern detection based on available data
                const odds = parseFloat(runner.lastPrice) || 0;
                const volume = runner.totalVolume || 0;
                
                if (odds > 0 && odds < 3) {
                    patterns.push({ type: 'steam', label: 'Steam Move' });
                }
                
                if (volume > 5000) {
                    patterns.push({ type: 'volume', label: 'High Volume' });
                }
                
                if (runner.bestBack && runner.bestLay) {
                    const spread = runner.bestLay - runner.bestBack;
                    if (spread < 0.05) {
                        patterns.push({ type: 'pressure', label: 'Back Pressure' });
                    }
                }
                
                return patterns;
            }

            calculateConfidence(runner, patterns) {
                let confidence = 50; // Base confidence
                
                const odds = parseFloat(runner.lastPrice) || 0;
                if (odds > 0) {
                    confidence += Math.min(30, (1 / odds) * 50);
                }
                
                confidence += patterns.length * 10;
                
                return Math.min(95, Math.round(confidence));
            }

            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connectionStatus');
                const textEl = document.getElementById('connectionText');
                
                if (connected) {
                    statusEl.className = 'connection-status connected';
                    textEl.textContent = 'Connected';
                } else {
                    statusEl.className = 'connection-status disconnected';
                    textEl.textContent = 'Disconnected';
                }
            }

            handleReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`Reconnecting in ${this.reconnectDelay}ms (attempt ${this.reconnectAttempts})`);
                    setTimeout(() => this.connect(), this.reconnectDelay);
                    this.reconnectDelay = Math.min(this.reconnectDelay * 1.5, 10000);
                }
            }

            renderSchedule() {
                const container = document.getElementById('racingContainer');
                
                if (this.courses.size === 0) {
                    container.innerHTML = `
                        <div class="no-racing">
                            <h3>No UK/Ireland racing found</h3>
                            <p>Check back tomorrow for the next racing schedule</p>
                        </div>
                    `;
                    return;
                }

                const coursesHtml = Array.from(this.courses.values())
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .map(course => this.renderCourseCard(course))
                    .join('');

                container.innerHTML = `<div class="courses-grid">${coursesHtml}</div>`;
                
                // Add event listeners
                this.addEventListeners();
            }

            renderCourseCard(course) {
                const totalPatterns = course.races.reduce((sum, race) => 
                    sum + race.runners.filter(r => r.patterns.length > 0).length, 0
                );

                const racesHtml = course.races.map(race => {
                    const timeStr = race.startTime.toLocaleTimeString('en-GB', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const now = new Date();
                    const minutesToRace = Math.round((race.startTime - now) / (1000 * 60));
                    const timeToRace = minutesToRace > 0 ? `${minutesToRace}m` : 'Started';
                    const isRacingSoon = minutesToRace > 0 && minutesToRace <= 15;

                    return `
                        <div class="race-item" data-race-id="${race.marketId}">
                            <div>
                                <div class="race-time">${timeStr}</div>
                                <div class="race-name">${race.name}</div>
                            </div>
                            <div class="race-status">
                                <span class="runners-count">${race.runners.length} runners</span>
                                ${race.hasPatterns ? '<span class="pattern-indicator">PATTERNS</span>' : ''}
                                <span class="time-to-race ${isRacingSoon ? 'soon' : ''}">${timeToRace}</span>
                            </div>
                        </div>
                        <div class="race-details" id="details-${race.marketId}">
                            <div class="details-header">
                                ${race.name} - ${timeStr}
                            </div>
                            <div class="horses-list">
                                ${this.renderHorses(race.runners)}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="course-card">
                        <div class="course-header">
                            <div class="course-name">${course.name}</div>
                            <div class="course-info">
                                <span>${course.races.length} races today</span>
                                ${totalPatterns > 0 ? `<span>${totalPatterns} patterns detected</span>` : ''}
                            </div>
                        </div>
                        <div class="race-list">
                            ${racesHtml}
                        </div>
                    </div>
                `;
            }

            renderHorses(runners) {
                return runners.map(horse => {
                    const patternClass = horse.patterns.length > 2 ? 'strong-pattern' : 
                                       horse.patterns.length > 0 ? 'pattern-detected' : '';
                    
                    const patternsHtml = horse.patterns.map(pattern => 
                        `<span class="pattern-badge pattern-${pattern.type}">${pattern.label}</span>`
                    ).join('');

                    const odds = horse.odds > 0 ? horse.odds.toFixed(2) : 'N/A';

                    return `
                        <div class="horse-item ${patternClass}">
                            <div class="horse-info">
                                <div class="horse-name">${horse.name}</div>
                                <div class="horse-patterns">${patternsHtml}</div>
                            </div>
                            <div class="horse-stats">
                                <div class="horse-odds">${odds}</div>
                                <div class="confidence-score">${horse.confidence}% confidence</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            addEventListeners() {
                // Add click handlers for race items
                document.querySelectorAll('.race-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const raceId = item.dataset.raceId;
                        this.toggleRaceDetails(raceId, item);
                    });
                });
            }

            toggleRaceDetails(raceId, raceItem) {
                const detailsEl = document.getElementById(`details-${raceId}`);
                
                // Close other open details
                document.querySelectorAll('.race-details.open').forEach(el => {
                    if (el.id !== `details-${raceId}`) {
                        el.classList.remove('open');
                    }
                });
                
                document.querySelectorAll('.race-item.selected').forEach(el => {
                    el.classList.remove('selected');
                });

                // Toggle current details
                if (detailsEl.classList.contains('open')) {
                    detailsEl.classList.remove('open');
                    raceItem.classList.remove('selected');
                } else {
                    detailsEl.classList.add('open');
                    raceItem.classList.add('selected');
                }
            }

            updateRaceTimes() {
                // Update time-to-race displays
                document.querySelectorAll('.time-to-race').forEach(el => {
                    // This would need race start time data to update properly
                    // Implementation depends on how race data is stored
                });
            }
        }

        // Initialize the racing schedule
        document.addEventListener('DOMContentLoaded', () => {
            new DailyRacingSchedule();
        });
    </script>
</body>
</html>